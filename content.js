// Content script i√ßin g√ºvenlik kontrol√º - Birden fazla y√ºklenmesini √∂nle
(function() {
  'use strict';
  
  if (window.linkedinJobMonitorLoaded) {
    console.log('‚ö†Ô∏è Content script zaten y√ºkl√º, yeniden y√ºklenmesi engelleniyor');
    return;
  }
  window.linkedinJobMonitorLoaded = true;

console.log('üöÄ LinkedIn Job Monitor Content Script ba≈ülatƒ±ldƒ±');

// LinkedIn'deki t√ºm i≈ü ilanlarƒ±nƒ± topla - G√ºncellenmi≈ü versiyon
function getAllJobs() {
  const jobs = [];
  
  console.log('üîç ƒ∞≈ü ilanlarƒ± aranƒ±yor...');
  
  // LinkedIn'in g√ºncel yapƒ±sƒ±na g√∂re se√ßiciler
  const jobSelectors = [
    // Yeni LinkedIn yapƒ±sƒ± (2025)
    'a.job-card-job-posting-card-wrapper__card-link',
    '.job-card-job-posting-card-wrapper',
    // Eski yapƒ±lar
    '.jobs-search-results__list-item',
    '.job-card-container',
    '.job-card-list__entity-lockup',
    '.scaffold-layout__list-container li',
    // Alternatif yapƒ±lar
    '[data-job-id]',
    '.job-search-card',
    '.jobs-search-results li',
    '.job-card',
    // Genel li elementleri (job listelerinde)
    '.jobs-search__results-list li',
    'li[data-occludable-job-id]',
    'li[data-job-id]'
  ];
  
  let foundCards = [];
  
  // Her se√ßiciyi dene
  for (const selector of jobSelectors) {
    const cards = document.querySelectorAll(selector);
    if (cards.length > 0) {
      console.log(`‚úÖ ${selector} ile ${cards.length} kart bulundu`);
      foundCards = Array.from(cards);
      break; // ƒ∞lk ba≈üarƒ±lƒ± se√ßiciyi kullan
    }
  }
  
  // Hi√ß kart bulunamadƒ±ysa alternatif y√∂ntem
  if (foundCards.length === 0) {
    console.log('‚ö†Ô∏è Hi√ß i≈ü kartƒ± bulunamadƒ±, alternatif y√∂ntem deneniyor...');
    
    // Sayfa i√ßindeki t√ºm linkleri kontrol et
    const allLinks = document.querySelectorAll('a[href*="/jobs/view/"]');
    allLinks.forEach(link => {
      const container = link.closest('li, .job-card, [data-job-id], div[class*="job"]');
      if (container && !foundCards.includes(container)) {
        foundCards.push(container);
      }
    });
    
    console.log(`üîÑ Alternatif y√∂ntemle ${foundCards.length} kart bulundu`);
  }
  
  if (foundCards.length === 0) {
    console.log('‚ùå Hi√ß i≈ü ilanƒ± bulunamadƒ±. Sayfa yapƒ±sƒ± deƒüi≈ümi≈ü olabilir.');
    
    // Debug i√ßin sayfa yapƒ±sƒ±nƒ± kontrol et
    const possibleContainers = document.querySelectorAll('li, [class*="job"], [data-job]');
    console.log('üîç Sayfada bulunan potansiyel konteynerler:', possibleContainers.length);
    
    return [];
  }
  
  foundCards.forEach((card, index) => {
    try {
      console.log(`üìù Kart ${index + 1} i≈üleniyor...`);
      
      // ƒ∞≈ü ba≈ülƒ±ƒüƒ± - G√ºncel LinkedIn yapƒ±sƒ± i√ßin
      const titleSelectors = [
        // Yeni yapƒ± (2025)
        '.artdeco-entity-lockup__title strong',
        '.job-card-job-posting-card-wrapper__title strong',
        '.artdeco-entity-lockup__title',
        '.job-card-job-posting-card-wrapper__title',
        // Eski yapƒ±lar
        '.job-card-list__title a',
        '.job-card-container__link',
        '.job-card-container__job-title',
        '[data-test-job-title]',
        'a[href*="/jobs/view/"]',
        '.job-card-list__title',
        '.base-search-card__title a',
        'h3 a', 'h4 a',
        '.job-title a',
        '.sr-only + a' // Bazen ba≈ülƒ±k sr-only'den sonra gelir
      ];
      
      let titleEl = null;
      let titleText = '';
      
      for (const selector of titleSelectors) {
        titleEl = card.querySelector(selector);
        if (titleEl) {
          titleText = titleEl.textContent.trim();
          if (titleText.length > 0) {
            console.log(`‚úÖ Ba≈ülƒ±k bulundu: "${titleText}" (${selector})`);
            break;
          }
        }
      }
      
      // ≈ûirket adƒ± - G√ºncel LinkedIn yapƒ±sƒ± i√ßin
      const companySelectors = [
        // Yeni yapƒ± (2025)
        '.artdeco-entity-lockup__subtitle',
        '.artdeco-entity-lockup__subtitle div',
        // Eski yapƒ±lar
        '.job-card-container__company-name',
        '.job-card-container__primary-description',
        '.job-card-list__company-name',
        '[data-test-job-company-name]',
        '.base-search-card__subtitle a',
        '.job-card-container__company',
        'a[href*="/company/"]',
        '.company-name'
      ];
      
      let companyEl = null;
      let companyText = '';
      
      for (const selector of companySelectors) {
        companyEl = card.querySelector(selector);
        if (companyEl) {
          companyText = companyEl.textContent.trim();
          if (companyText.length > 0) {
            console.log(`‚úÖ ≈ûirket bulundu: "${companyText}" (${selector})`);
            break;
          }
        }
      }
      
      // Konum - G√ºncel LinkedIn yapƒ±sƒ± i√ßin
      const locationSelectors = [
        // Yeni yapƒ± (2025)
        '.artdeco-entity-lockup__caption',
        '.artdeco-entity-lockup__caption div',
        // Eski yapƒ±lar
        '.job-card-container__metadata-item',
        '.job-card-list__location',
        '[data-test-job-location]',
        '.job-card-container__metadata .tvm__text',
        '.base-search-card__metadata .tvm__text'
      ];
      
      let locationEl = null;
      let locationText = '';
      
      for (const selector of locationSelectors) {
        locationEl = card.querySelector(selector);
        if (locationEl) {
          locationText = locationEl.textContent.trim();
          if (locationText.length > 0 && !locationText.includes('ago') && !locationText.includes('√∂nce')) {
            console.log(`‚úÖ Konum bulundu: "${locationText}" (${selector})`);
            break;
          }
        }
      }
      
      // ƒ∞lan zamanƒ±
      const timeSelectors = [
        'time',
        '.job-card-container__listed-status',
        '.job-card-list__listed-date',
        '.tvm__text:last-child'
      ];
      
      let timeEl = null;
      let timeText = '';
      
      for (const selector of timeSelectors) {
        timeEl = card.querySelector(selector);
        if (timeEl) {
          timeText = timeEl.textContent.trim();
          if (timeText.includes('ago') || timeText.includes('√∂nce') || timeText.includes('hour') || timeText.includes('day')) {
            break;
          }
        }
      }
      
      // Easy Apply kontrol√º - G√ºncel LinkedIn yapƒ±sƒ± i√ßin
      let isEasyApply = false;
      
      // 1. Direkt class/attribute kontrol√º
      const easyApplySelectors = [
        // Yeni yapƒ± (2025)
        '.job-card-job-posting-card-wrapper__footer-item',
        // Eski yapƒ±lar
        '.job-card-container__easy-apply-label',
        '[aria-label*="Easy Apply"]',
        '.job-card-list__easy-apply-label',
        '.job-card-container__apply-link[aria-label*="Easy Apply"]',
        '[data-test-easy-apply]'
      ];
      
      for (const selector of easyApplySelectors) {
        const element = card.querySelector(selector);
        if (element) {
          const text = element.textContent.toLowerCase();
          // "Applied" durumunu da kontrol et (zaten ba≈üvurulmu≈ü)
          if (text.includes('easy apply') || text.includes('kolay ba≈üvuru') || 
              text.includes('applied') || text.includes('ba≈üvuruldu')) {
            isEasyApply = true;
            break;
          }
        }
      }
      
      // 2. Text i√ßeriƒüi kontrol√º
      if (!isEasyApply) {
        const allText = card.textContent.toLowerCase();
        if (allText.includes('easy apply') || allText.includes('kolay ba≈üvuru')) {
          isEasyApply = true;
        }
      }
      
      // 3. Button text kontrol√º
      if (!isEasyApply) {
        const buttons = card.querySelectorAll('button, a');
        buttons.forEach(btn => {
          const btnText = btn.textContent.toLowerCase();
          if (btnText.includes('easy apply') || btnText.includes('kolay ba≈üvuru')) {
            isEasyApply = true;
          }
        });
      }
      
      // Link bulma - G√ºncel LinkedIn yapƒ±sƒ± i√ßin
      let jobUrl = '';
      let jobId = '';
      
      // √ñnce link elementi olup olmadƒ±ƒüƒ±nƒ± kontrol et (a tag'i)
      if (card.tagName === 'A') {
        jobUrl = card.href;
      } else if (titleEl && titleEl.href) {
        jobUrl = titleEl.href;
      } else {
        // Alternatif link arama
        const linkEl = card.querySelector('a[href*="/jobs/view/"], a.job-card-job-posting-card-wrapper__card-link');
        if (linkEl) {
          jobUrl = linkEl.href;
        }
      }
      
      // Job ID √ßƒ±karma - currentJobId parametresinden de al
      if (jobUrl) {
        // √ñnce currentJobId parametresini kontrol et
        const currentJobMatch = jobUrl.match(/[?&]currentJobId=(\d+)/);
        if (currentJobMatch) {
          jobId = currentJobMatch[1];
        } else {
          // Standart URL'den al
          const idMatch = jobUrl.match(/\/jobs\/view\/(\d+)/);
          if (idMatch) {
            jobId = idMatch[1];
          }
        }
      }
      
      // Job ID yoksa data attribute'lerden al
      if (!jobId) {
        jobId = card.getAttribute('data-job-id') || 
               card.getAttribute('data-occludable-job-id') || 
               card.getAttribute('data-entity-urn')?.split(':').pop() ||
               Date.now().toString() + Math.random().toString(36).substr(2, 9);
      }
      
      // Minimum gereksinimler kontrol√º
      if (titleText && jobUrl && jobId) {
        const job = {
          id: jobId,
          title: titleText,
          company: companyText || '≈ûirket belirtilmemi≈ü',
          location: locationText || 'Konum belirtilmemi≈ü',
          url: jobUrl,
          postedTime: timeText || '',
          isEasyApply: isEasyApply
        };
        
        console.log(`‚úÖ ƒ∞≈ü eklendi:`, job);
        jobs.push(job);
      } else {
        console.log(`‚ö†Ô∏è Eksik bilgi:`, {
          title: titleText,
          url: jobUrl,
          id: jobId
        });
      }
    } catch (error) {
      console.error('‚ùå ƒ∞≈ü ilanƒ± √ßƒ±karma hatasƒ±:', error);
    }
  });
  
  console.log(`üéâ Toplam ${jobs.length} i≈ü ilanƒ± bulundu`);
  return jobs;
}

// Anahtar kelimeleri rastgele sƒ±rala
function shuffleKeywords(keywords) {
  const shuffled = [...keywords];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

// Rastgele varyasyonlar olu≈ütur
function createSearchVariation(keywords) {
  if (!keywords || keywords.length === 0) return '';
  
  // Tek kelime varsa farklƒ± varyasyonlar ekle
  if (keywords.length === 1) {
    const baseKeyword = keywords[0];
    const variations = [
      `${baseKeyword} developer`,
      `${baseKeyword} engineer`,
      `${baseKeyword} programming`,
      `${baseKeyword} software`,
      `senior ${baseKeyword}`,
      `${baseKeyword} specialist`
    ];
    
    // Rastgele bir varyasyon se√ß
    const randomVariation = variations[Math.floor(Math.random() * variations.length)];
    console.log(`üé≤ Tek kelime i√ßin varyasyon: "${baseKeyword}" ‚Üí "${randomVariation}"`);
    return randomVariation;
  }
  
  // √áoklu kelimeler i√ßin rastgele sƒ±rala
  const shuffled = shuffleKeywords(keywords);
  const connectors = [' OR ', ' | ', ' AND '];
  const randomConnector = connectors[Math.floor(Math.random() * connectors.length)];
  
  console.log(`üé≤ Rastgele sƒ±ralama: [${keywords.join(', ')}] ‚Üí [${shuffled.join(', ')}]`);
  console.log(`üîó Kullanƒ±lan baƒüla√ß: "${randomConnector}"`);
  
  return shuffled.join(randomConnector);
}

// Otomatik arama yapma fonksiyonu - Rastgele varyasyonlu versiyon
function performAutoSearch(originalSearchTerms) {
  console.log('üîç Otomatik arama ba≈ülatƒ±lƒ±yor (orijinal):', originalSearchTerms);
  
  // Keywords array'ini al
  const keywordsArray = originalSearchTerms.split(' OR ').map(k => k.trim());
  
  // Tek kelime ise sayfa yenile, √ßoklu ise rastgele sƒ±rala
  if (keywordsArray.length === 1) {
    console.log('üîÑ Tek kelime tespit edildi, sayfa yenileniyor...');
    
    // Ge√ßerli URL'yi temizle
    const baseUrl = 'https://www.linkedin.com/jobs/search/';
    window.location.href = baseUrl;
    
    // Storage'a yenileme bilgisi kaydet
    chrome.storage.local.set({
      pendingSearchTerms: originalSearchTerms,
      pendingSearchTime: Date.now()
    });
    
    return true;
  }
  
  // √áoklu kelime - rastgele varyasyon olu≈ütur
  const searchVariation = createSearchVariation(keywordsArray);
  console.log('üéØ Kullanƒ±lacak arama terimi:', searchVariation);
  
  // Sonsuz d√∂ng√ºy√º √∂nlemek i√ßin flag kontrol et
  if (window.searchInProgress) {
    console.log('‚ö†Ô∏è Arama zaten devam ediyor, atlanƒ±yor...');
    return false;
  }
  
  window.searchInProgress = true;
  
  // 30 saniye sonra flag'i temizle (g√ºvenlik i√ßin)
  setTimeout(() => {
    window.searchInProgress = false;
  }, 30000);
  
  // LinkedIn arama inputunu bul
  const searchSelectors = [
    'input[aria-label*="Search by title"]',
    'input[placeholder*="Search by title"]',
    'input.jobs-search-box__text-input',
    'input[role="combobox"][id*="jobs-search"]',
    'input[name="keywords"]',
    '.jobs-search-box input[type="text"]'
  ];
  
  let searchInput = null;
  
  for (const selector of searchSelectors) {
    searchInput = document.querySelector(selector);
    if (searchInput) {
      console.log(`‚úÖ Arama kutusu bulundu: ${selector}`);
      break;
    }
  }
  
  if (!searchInput) {
    console.error('‚ùå Arama kutusu bulunamadƒ±');
    window.searchInProgress = false;
    return false;
  }
  
  // Input'u tamamen temizle
  searchInput.value = '';
  searchInput.focus();
  
  // Select all + delete (tamamen temizlemek i√ßin)
  setTimeout(() => {
    searchInput.select();
    document.execCommand('delete');
    
    setTimeout(() => {
      // Yeni rastgele terimi yaz
      searchInput.value = searchVariation;
      
      // Input event'lerini tetikle
      searchInput.dispatchEvent(new Event('input', { bubbles: true }));
      searchInput.dispatchEvent(new Event('change', { bubbles: true }));
      searchInput.dispatchEvent(new Event('keyup', { bubbles: true }));
      
      console.log('üìù Rastgele arama metni yazƒ±ldƒ±:', searchVariation);
      
      // Enter'a bas
      setTimeout(() => {
        const enterEvent = new KeyboardEvent('keydown', {
          key: 'Enter',
          code: 'Enter',
          keyCode: 13,
          which: 13,
          bubbles: true,
          cancelable: true
        });
        
        searchInput.dispatchEvent(enterEvent);
        console.log('‚å®Ô∏è Enter tu≈üu g√∂nderildi');
        
        // Alternatif: Form submit
        const form = searchInput.closest('form');
        if (form) {
          setTimeout(() => {
            console.log('üì§ Form submit yedek tetikleniyor...');
            form.submit();
          }, 1000);
        }
        
        // Arama ba≈üarƒ±sƒ±nƒ± kontrol et
        setTimeout(() => {
          const newUrl = window.location.href;
          const hasKeywords = newUrl.includes('keywords') || newUrl.toLowerCase().includes(encodeURIComponent(searchVariation.toLowerCase()));
          
          if (hasKeywords) {
            console.log('‚úÖ Rastgele arama ba≈üarƒ±lƒ± - URL deƒüi≈üti');
          } else {
            console.log('‚ö†Ô∏è URL deƒüi≈ümedi, search butonuna tƒ±klanƒ±yor...');
            
            // Search butonunu bul ve tƒ±kla
            const searchButton = document.querySelector(
              'button[aria-label*="Search"], ' +
              'button[type="submit"], ' +
              '.jobs-search-box__submit-button'
            );
            
            if (searchButton) {
              console.log('üîò Search butonuna tƒ±klanƒ±yor...');
              searchButton.click();
            }
          }
          
          // Flag'i temizle
          setTimeout(() => {
            window.searchInProgress = false;
          }, 3000);
          
        }, 3000);
        
      }, 1500);
    }, 500);
  }, 500);
  
  return true;
}

// Konum filtresini ayarla
function setLocationFilter(location) {
  console.log('üìç Konum filtresi ayarlanƒ±yor:', location);
  
  // Konum butonunu bul ve tƒ±kla
  const locationButton = document.querySelector(
    'button[aria-label*="City, state, or zip code"], ' +
    'button[aria-label*="Location"], ' +
    '.search-reusables__filter-binary-toggle button'
  );
  
  if (locationButton) {
    locationButton.click();
    
    setTimeout(() => {
      // Konum inputunu bul
      const locationInput = document.querySelector(
        'input[aria-label*="City, state, or zip code"], ' +
        'input[placeholder*="City, state, or zip code"], ' +
        'input#jobs-search-box-location-id'
      );
      
      if (locationInput) {
        locationInput.value = '';
        locationInput.focus();
        locationInput.value = location;
        locationInput.dispatchEvent(new Event('input', { bubbles: true }));
        
        // Dropdown'dan ilk sonucu se√ß
        setTimeout(() => {
          const firstOption = document.querySelector(
            '.basic-typeahead__triggered-content li:first-child'
          );
          if (firstOption) {
            firstOption.click();
          }
        }, 1000);
      }
    }, 500);
  }
}

// Date Posted filtresini ayarla
function setDatePostedFilter(dateFilter) {
  console.log('üìÖ Tarih filtresi ayarlanƒ±yor:', dateFilter);
  
  // Date posted dropdown butonunu bul
  const datePostedBtn = document.querySelector(
    'button[aria-label*="Date posted"], ' +
    'button[aria-label*="Date Posted"], ' +
    'button[id*="searchFilter_timePostedRange"]'
  );
  
  if (datePostedBtn) {
    datePostedBtn.click();
    
    setTimeout(() => {
      // Dropdown i√ßindeki radio butonlarƒ± bul
      let dateOption;
      
      switch(dateFilter) {
        case '24h':
          // Past 24 hours se√ßeneƒüini bul
          const labels = document.querySelectorAll('label');
          labels.forEach(label => {
            if (label.textContent && label.textContent.includes('Past 24 hours')) {
              dateOption = label;
            }
          });
          break;
        case 'week':
          // Past week se√ßeneƒüini bul
          const weekLabels = document.querySelectorAll('label');
          weekLabels.forEach(label => {
            if (label.textContent && label.textContent.includes('Past week')) {
              dateOption = label;
            }
          });
          break;
        case 'month':
          // Past month se√ßeneƒüini bul
          const monthLabels = document.querySelectorAll('label');
          monthLabels.forEach(label => {
            if (label.textContent && label.textContent.includes('Past month')) {
              dateOption = label;
            }
          });
          break;
      }
      
      if (dateOption) {
        // Radio button'ƒ± se√ß
        const radioInput = dateOption.querySelector('input[type="radio"]');
        if (radioInput) {
          radioInput.click();
        } else {
          dateOption.click();
        }
        
        // Show results butonuna tƒ±kla
        setTimeout(() => {
          const showResultsBtn = document.querySelector(
            'button[aria-label*="Show results"], ' +
            'button[aria-label*="Apply filters"]'
          );
          
          if (!showResultsBtn) {
            // Text ile ara
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
              if (btn.textContent && btn.textContent.includes('Show results')) {
                btn.click();
              }
            });
          } else {
            showResultsBtn.click();
          }
        }, 300);
      }
    }, 500);
  }
}

// Easy Apply filtresini ayarla
function setEasyApplyFilter(onlyEasyApply) {
  if (!onlyEasyApply) return;
  
  console.log('‚ö° Easy Apply filtresi ayarlanƒ±yor');
  
  // All filters butonunu bul
  let allFiltersBtn = document.querySelector('button[aria-label="Show all filters"]');
  
  if (!allFiltersBtn) {
    const buttons = document.querySelectorAll('button');
    buttons.forEach(button => {
      if (button.textContent && button.textContent.includes('All filters')) {
        allFiltersBtn = button;
      }
    });
  }
  
  if (allFiltersBtn) {
    allFiltersBtn.click();
    
    setTimeout(() => {
      // Easy Apply toggle'ƒ±nƒ± bul
      const easyApplyToggle = document.querySelector(
        'input[id*="f_LF"][value="f_AL"], ' +
        'input[id*="f_AL"], ' +
        'label[for*="f_AL"] input'
      );
      
      if (easyApplyToggle && !easyApplyToggle.checked) {
        easyApplyToggle.click();
      }
      
      // Apply/Show results butonuna tƒ±kla
      setTimeout(() => {
        const applyBtn = document.querySelector(
          'button[aria-label*="Apply filters"], ' +
          'button[aria-label*="Show results"]'
        );
        
        if (!applyBtn) {
          // Text ile ara
          const buttons = document.querySelectorAll('button');
          buttons.forEach(btn => {
            if (btn.textContent && 
                (btn.textContent.includes('Apply filters') || 
                 btn.textContent.includes('Show results'))) {
              btn.click();
            }
          });
        } else {
          applyBtn.click();
        }
      }, 500);
    }, 1000);
  }
}

// Heartbeat fonksiyonu - Extension'ƒ±n aktif olduƒüunu background'a bildir
function sendHeartbeat() {
  try {
    chrome.runtime.sendMessage({ 
      action: 'heartbeat',
      timestamp: Date.now(),
      url: window.location.href
    }).catch(error => {
      console.log('Heartbeat g√∂nderilemedi:', error);
    });
  } catch (error) {
    console.log('Heartbeat hatasƒ±:', error);
  }
}

// Background'dan gelen mesajlarƒ± dinle
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  console.log('üì® Mesaj alƒ±ndƒ±:', request.action);
  
  try {
    if (request.action === 'getAllJobs') {
      console.log('üìã ƒ∞≈ü ilanlarƒ± talep edildi');
      const jobs = getAllJobs();
      
      console.log(`üìä Bulunan i≈ü sayƒ±sƒ±: ${jobs.length}`);
      
      if (jobs.length > 0) {
        chrome.runtime.sendMessage({
          action: 'newJobsDetected',
          jobs: jobs
        }).catch(err => console.log('Mesaj g√∂nderme hatasƒ±:', err));
      }
      
      // Sync response
      sendResponse({ success: true, jobCount: jobs.length });
      return false; // Sync response olduƒüunu belirt
      
    } else if (request.action === 'performSearch') {
      // Otomatik arama yap
      const { keywords, location, datePosted, easyApply } = request;
      
      // Arama terimlerini birle≈ütir
      const searchQuery = keywords.join(' OR ');
      
      console.log('üéØ Arama parametreleri:', { searchQuery, location, datePosted, easyApply });
      
      // Hemen response g√∂nder
      sendResponse({ success: true, message: 'Arama ba≈ülatƒ±ldƒ±' });
      
      // Aramayƒ± async olarak yap
      setTimeout(() => {
        const searchSuccess = performAutoSearch(searchQuery);
        
        if (searchSuccess) {
          console.log('‚úÖ Arama ba≈ülatƒ±ldƒ±, filtrelerin uygulanmasƒ± bekleniyor...');
          
          // Arama sonu√ßlarƒ±nƒ±n y√ºklenmesini bekle
          setTimeout(() => {
            
            // Date Posted filtresini uygula
            if (datePosted) {
              console.log('üìÖ Tarih filtresi uygulanƒ±yor...');
              setDatePostedFilter(datePosted);
            }
            
            // Konum filtresini uygula
            if (location) {
              setTimeout(() => {
                console.log('üìç Konum filtresi uygulanƒ±yor...');
                setLocationFilter(location);
              }, 2000);
            }
            
            // Easy Apply filtresini uygula
            if (easyApply) {
              setTimeout(() => {
                console.log('‚ö° Easy Apply filtresi uygulanƒ±yor...');
                setEasyApplyFilter(true);
              }, 4000);
            }
            
            // T√ºm filtreler uygulandƒ±ktan sonra sonu√ßlarƒ± topla
            setTimeout(() => {
              console.log('üèÅ Arama tamamlandƒ±, sonu√ßlar toplanƒ±yor...');
              const jobs = getAllJobs();
              console.log('üéâ Arama sonu√ßlarƒ±:', jobs.length, 'ilan bulundu');
              
              if (jobs.length > 0) {
                chrome.runtime.sendMessage({
                  action: 'newJobsDetected',
                  jobs: jobs
                }).catch(err => console.log('Mesaj g√∂nderme hatasƒ±:', err));
              } else {
                console.log('‚ö†Ô∏è Hi√ß ilan bulunamadƒ±, sayfa yapƒ±sƒ± kontrol ediliyor...');
                
                // Debug i√ßin sayfa yapƒ±sƒ±nƒ± kontrol et
                setTimeout(() => {
                  const allLinks = document.querySelectorAll('a[href*="/jobs/view/"]');
                  console.log('üîç Sayfada bulunan i≈ü linkleri:', allLinks.length);
                  
                  const potentialCards = document.querySelectorAll('li, [class*="job"], [data-job]');
                  console.log('üîç Potansiyel i≈ü kartlarƒ±:', potentialCards.length);
                }, 1000);
              }
            }, 8000); // 8 saniye sonra sonu√ßlarƒ± topla
            
          }, 5000); // 5 saniye sonra filtreleri uygulamaya ba≈üla
        } else {
          console.log('‚ùå Arama ba≈ülatƒ±lamadƒ±');
        }
      }, 100);
      
      return false; // Sync response kullan
      
    } else if (request.action === 'playSound') {
      // Bildirim sesi √ßal
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBD6S1Oy9diMFl2z7n8A7+hWZyuvy2LK2pJKigGeIY8LszKkeGTqN0+2ukjMJHnt/ksbLkxwYOYrU6bWVLwkejMD03Yz/Dp9ZIAunup/wwWQVCyuBz/TOhgsGQ4LL7sV5GwdWiub7spQRCHJ2N1+0936bsZ2mg4Bdf3iOt7uTMw0lia3m8ahdFApKkeHyyGYhBCCI0PD3nRYGPYTN79KBJAgUgNPy0Hkc');
        audio.volume = 0.5;
        audio.play();
      } catch (e) {
        console.log('üîá Ses √ßalƒ±namadƒ±:', e);
      }
      sendResponse({ success: true });
      return false;
      
    } else if (request.action === 'ping') {
      // Ping-pong yanƒ±tƒ± - Extension'ƒ±n aktif olduƒüunu g√∂sterir
      console.log('üèì Ping alƒ±ndƒ±, pong g√∂nderiliyor');
      sendResponse({ success: true, timestamp: Date.now() });
      return false;
    }
  } catch (error) {
    console.error('‚ùå Mesaj i≈üleme hatasƒ±:', error);
    sendResponse({ success: false, error: error.message });
    return false;
  }
});

// Sayfa deƒüi≈üikliklerini izle (LinkedIn dinamik i√ßerik y√ºklediƒüinde)
// Observer sadece bir kez tanƒ±mlanmasƒ±nƒ± saƒüla
if (!window.linkedinJobObserver) {
  console.log('üîç Mutation Observer ba≈ülatƒ±lƒ±yor...');
  
  window.linkedinJobObserver = new MutationObserver((mutations) => {
    // B√ºy√ºk deƒüi≈üiklikler olduƒüunda kontrol et
    const hasSignificantChanges = mutations.some(mutation => 
      mutation.addedNodes.length > 5 || 
      (mutation.target.classList && mutation.target.classList.contains('jobs-search-results'))
    );
    
    if (hasSignificantChanges) {
      console.log('üîÑ Sayfa i√ßeriƒüi deƒüi≈üti, yeni ilanlar kontrol ediliyor...');
      // 2 saniye bekle, LinkedIn'in y√ºklemesini tamamlamasƒ± i√ßin
      setTimeout(() => {
        const jobs = getAllJobs();
        if (jobs.length > 0) {
          chrome.runtime.sendMessage({
            action: 'newJobsDetected',
            jobs: jobs
          });
        }
      }, 2000);
    }
  });

  // Observer'ƒ± ba≈ülat
  const targetNode = document.querySelector('body');
  if (targetNode) {
    window.linkedinJobObserver.observe(targetNode, {
      childList: true,
      subtree: true
    });
    console.log('‚úÖ Mutation Observer ba≈ülatƒ±ldƒ±');
  }
}

// Heartbeat'i d√ºzenli aralƒ±klarla g√∂nder
setInterval(sendHeartbeat, 30000); // Her 30 saniyede bir

// ƒ∞lk y√ºklemede kontrol et
setTimeout(() => {
  console.log('üöÄ Extension ba≈ülatƒ±ldƒ±, ilk kontrol yapƒ±lƒ±yor...');
  
  // Sonsuz d√∂ng√ºy√º √∂nlemek i√ßin kontrol
  if (window.initialCheckDone) {
    console.log('‚ö†Ô∏è ƒ∞lk kontrol zaten yapƒ±ldƒ±, atlanƒ±yor...');
    return;
  }
  
  window.initialCheckDone = true;
  
  // ƒ∞lk heartbeat g√∂nder
  sendHeartbeat();
  
  // Bekleyen arama var mƒ± kontrol et (tek kelime yenilemesi sonrasƒ±)
  chrome.storage.local.get(['pendingSearchTerms', 'pendingSearchTime'], (result) => {
    const now = Date.now();
    const isPendingSearch = result.pendingSearchTime && (now - result.pendingSearchTime < 10000); // 10 saniye i√ßinde
    
    if (isPendingSearch && result.pendingSearchTerms) {
      console.log('üîÑ Sayfa yenileme sonrasƒ± bekleyen arama var:', result.pendingSearchTerms);
      
      // Bekleyen aramayƒ± temizle
      chrome.storage.local.remove(['pendingSearchTerms', 'pendingSearchTime']);
      
      // Tek kelimelik arama i√ßin varyasyon yap
      setTimeout(() => {
        const searchVariation = createSearchVariation([result.pendingSearchTerms]);
        console.log('üéØ Tek kelime i√ßin varyasyon yapƒ±lƒ±yor:', searchVariation);
        
        // Arama inputunu bul ve varyasyonu yaz
        const searchInput = document.querySelector(
          'input[aria-label*="Search by title"], ' +
          'input[placeholder*="Search by title"], ' +
          'input.jobs-search-box__text-input'
        );
        
        if (searchInput) {
          searchInput.value = searchVariation;
          searchInput.dispatchEvent(new Event('input', { bubbles: true }));
          
          setTimeout(() => {
            searchInput.dispatchEvent(new KeyboardEvent('keydown', {
              key: 'Enter',
              keyCode: 13,
              bubbles: true
            }));
            console.log('‚úÖ Tek kelime varyasyonu ile arama yapƒ±ldƒ±');
          }, 1000);
        }
      }, 2000);
      
      return;
    }
    
    // Normal ilk kontrol
    const jobs = getAllJobs();
    console.log(`üèÅ ƒ∞lk kontrol: ${jobs.length} ilan bulundu`);
    
    if (jobs.length > 0) {
      chrome.runtime.sendMessage({
        action: 'newJobsDetected',
        jobs: jobs
      }).catch(err => console.log('Mesaj g√∂nderme hatasƒ±:', err));
    }
    
    // Sadece ana jobs sayfasƒ±ndaysa ve arama yapƒ±lmamƒ±≈üsa otomatik arama ba≈ülat
    const currentUrl = window.location.href;
    const isMainJobsPage = currentUrl.includes('/jobs/') && 
                          !currentUrl.includes('keywords') && 
                          !currentUrl.includes('search') && 
                          !currentUrl.includes('currentJobId');
    
    if (isMainJobsPage && jobs.length === 0) {
      chrome.storage.local.get(['filters'], (result) => {
        if (result.filters && result.filters.keywords && result.filters.keywords.length > 0) {
          console.log('üéØ Kriterler bulundu, otomatik arama ba≈ülatƒ±lƒ±yor...');
          setTimeout(() => {
            chrome.runtime.sendMessage({ action: 'requestAutoSearch' })
              .catch(err => console.log('Auto search request hatasƒ±:', err));
          }, 2000);
        }
      });
    }
  });
}, 3000);

console.log('‚úÖ LinkedIn Job Monitor Content Script tamamen y√ºklendi');

})(); // IIFE kapatma